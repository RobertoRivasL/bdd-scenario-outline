package com.curso.automatizacion.steps;

import io.cucumber.java.After;
import io.cucumber.java.Before;
import io.cucumber.java.es.*;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.By;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.openqa.selenium.support.ui.ExpectedConditions;
import io.github.bonigarcia.wdm.WebDriverManager;
import java.time.Duration;
import static org.junit.jupiter.api.Assertions.*;

/**
 * Step Definitions CORREGIDOS para Calculadora
 * SIN duplicados de métodos - Solo un método por step
 */
public class CalculadoraSteps {
    private WebDriver driver;
    private WebDriverWait wait;

    @Before
    public void setUp() {
        WebDriverManager.chromedriver().setup();
        ChromeOptions options = new ChromeOptions();
        
        // Configuración para headless si es necesario
        if (Boolean.parseBoolean(System.getProperty("webdriver.headless", "false"))) {
            options.addArguments("--headless");
        }
        
        options.addArguments("--no-sandbox");
        options.addArguments("--disable-dev-shm-usage");
        options.addArguments("--window-size=1920,1080");
        options.addArguments("--disable-gpu");
        
        driver = new ChromeDriver(options);
        wait = new WebDriverWait(driver, Duration.ofSeconds(10));
    }

    @After
    public void tearDown() {
        if (driver != null) {
            driver.quit();
        }
    }

    @Dado("que estoy en la página de la calculadora")
    public void queEstoyEnLaPaginaDeLaCalculadora() {
        String rutaAplicacion = "file://" + System.getProperty("user.dir") + "/src/test/resources/calculadora.html";
        driver.get(rutaAplicacion);
        
        WebElement titulo = wait.until(
            ExpectedConditions.presenceOfElementLocated(By.tagName("h1"))
        );
        assertTrue(titulo.getText().contains("Calculadora"));
    }

    @Dado("que he realizado una operación")
    public void queHeRealizadoUnaOperacion() {
        ingresarNumero("numero1", "10");
        ingresarNumero("numero2", "5");
        hacerClicEnBoton("suma");
    }

    // ===== MÉTODOS ÚNICOS PARA NÚMEROS (sin duplicados) =====
    
    @Cuando("ingreso el primer número {}")
    public void ingresoElPrimerNumero(String numero) {
        ingresarNumero("numero1", numero);
    }

    @Y("ingreso el segundo número {}")
    public void ingresoElSegundoNumero(String numero) {
        ingresarNumero("numero2", numero);
    }

    @Y("hago clic en el botón de {word}")
    public void hagoClicEnElBotonDe(String operacion) {
        hacerClicEnBoton(operacion);
    }

    @Cuando("hago clic en el botón {string}")
    public void hagoClicEnElBoton(String nombreBoton) {
        switch (nombreBoton.toLowerCase()) {
            case "limpiar":
                hacerClicEnBoton("limpiar");
                break;
            case "=":
            case "igual":
                hacerClicEnBoton("igual");
                break;
            default:
                throw new IllegalArgumentException("Botón no reconocido: " + nombreBoton);
        }
    }

    // ===== MÉTODOS DE VERIFICACIÓN =====

    @Entonces("el resultado debe ser {}")
    public void elResultadoDebeSer(String resultadoEsperado) {
        WebElement resultado = wait.until(
            ExpectedConditions.presenceOfElementLocated(
                By.cssSelector("[data-testid='resultado-valor']")
            )
        );
        
        String textoResultado = resultado.getText();
        assertFalse(textoResultado.contains("Error"), "No debería haber error: " + textoResultado);
        
        // Convertir ambos a double para comparar
        double esperado = Double.parseDouble(resultadoEsperado);
        double real = Double.parseDouble(textoResultado);
        
        assertEquals(esperado, real, 0.01, 
            "Esperado: " + esperado + ", pero fue: " + real);
    }

    @Entonces("el resultado debe ser aproximadamente {}")
    public void elResultadoDebeSerAproximadamente(String resultadoEsperado) {
        WebElement resultado = wait.until(
            ExpectedConditions.presenceOfElementLocated(
                By.cssSelector("[data-testid='resultado-valor']")
            )
        );
        
        String textoResultado = resultado.getText();
        double esperado = Double.parseDouble(resultadoEsperado);
        double real = Double.parseDouble(textoResultado);
        
        assertEquals(esperado, real, 0.1, 
            "Esperado aproximadamente: " + esperado + ", pero fue: " + real);
    }

    @Y("la operación mostrada debe contener {string}")
    public void laOperacionMostradaDebeContener(String expresionEsperada) {
        WebElement operacion = wait.until(
            ExpectedConditions.presenceOfElementLocated(
                By.cssSelector("[data-testid='resultado-operacion']")
            )
        );
        
        String textoOperacion = operacion.getText();
        assertTrue(textoOperacion.contains(expresionEsperada), 
            "La operación '" + textoOperacion + "' debería contener '" + expresionEsperada + "'");
    }

    @Entonces("debe mostrar el mensaje de error {string}")
    public void debeMostrarElMensajeDeError(String mensajeEsperado) {
        WebElement resultado = wait.until(
            ExpectedConditions.presenceOfElementLocated(
                By.cssSelector("[data-testid='resultado-valor']")
            )
        );
        
        String textoResultado = resultado.getText();
        assertEquals(mensajeEsperado, textoResultado,
            "Mensaje de error esperado: '" + mensajeEsperado + "', pero fue: '" + textoResultado + "'");
    }

    @Entonces("los campos de entrada deben estar vacíos")
    public void losCamposDeEntradaDebenEstarVacios() {
        WebElement numero1 = driver.findElement(By.cssSelector("[data-testid='numero1']"));
        WebElement numero2 = driver.findElement(By.cssSelector("[data-testid='numero2']"));
        
        assertEquals("", numero1.getAttribute("value"), "El primer número debería estar vacío");
        assertEquals("", numero2.getAttribute("value"), "El segundo número debería estar vacío");
    }

    @Y("el resultado debe mostrar {string}")
    public void elResultadoDebeMostrar(String textoEsperado) {
        WebElement resultado = wait.until(
            ExpectedConditions.presenceOfElementLocated(
                By.cssSelector("[data-testid='resultado-valor']")
            )
        );
        
        assertEquals(textoEsperado, resultado.getText());
    }

    @Y("la operación debe mostrar {string}")
    public void laOperacionDebeMostrar(String textoEsperado) {
        WebElement operacion = wait.until(
            ExpectedConditions.presenceOfElementLocated(
                By.cssSelector("[data-testid='resultado-operacion']")
            )
        );
        
        assertEquals(textoEsperado, operacion.getText());
    }

    // ===== MÉTODOS AUXILIARES PRIVADOS =====

    private void ingresarNumero(String campo, String valor) {
        WebElement elemento = wait.until(
            ExpectedConditions.presenceOfElementLocated(
                By.cssSelector("[data-testid='" + campo + "']")
            )
        );
        elemento.clear();
        elemento.sendKeys(valor);
        
        // Pequeña pausa para asegurar que el valor se ingrese
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }

    private void hacerClicEnBoton(String operacion) {
        String dataTestId = mapearOperacionATestId(operacion);
        
        WebElement boton = wait.until(
            ExpectedConditions.elementToBeClickable(
                By.cssSelector("[data-testid='" + dataTestId + "']")
            )
        );
        boton.click();
        
        // Esperar a que se procese la operación
        try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }

    private String mapearOperacionATestId(String operacion) {
        switch (operacion.toLowerCase()) {
            case "suma": return "btn-suma";
            case "resta": return "btn-resta";
            case "multiplicacion": return "btn-multiplicacion";
            case "division": return "btn-division";
            case "limpiar": return "btn-limpiar";
            case "igual": return "btn-igual";
            default:
                throw new IllegalArgumentException("Operación no reconocida: " + operacion);
        }
    }
}
